import Foundation
import Utility

func main() {
	var inputPath: String!
	var outputPath: String!
	var imports: [String]?

	let arguments = Array(CommandLine.arguments.dropFirst())

	let parser = ArgumentParser(
		usage: "genswiftstoryboards --in <storyboards path> --out <swift output file path>  --imports <Framework imports> "
	, 	overview: "This tool generates code from storyboards"
	)

	let inOpt = parser.add(option: "--in", shortName: nil, kind: String.self, usage: "path to storyboards folder", completion: nil)
	let outOpt = parser.add(option: "--out", shortName: nil, kind: String.self, usage: "path to output swift source file", completion: nil)
	let importsOpt = parser.add(option: "--imports", shortName: nil, kind: [String].self, usage: "additional Framework imports", completion: nil)

	do {
		let result = try parser.parse(arguments)
		inputPath = result.get(inOpt)
		outputPath = result.get(outOpt)
		imports = result.get(importsOpt)
	} catch {
		print("error: \(error)")
		return
	}

	autogeneratedLine()
	line("import UIKit")
	line("import ExtraKit")
	imports?.forEach { line("import \($0)") }
	line()
	findFiles(extension: ["storyboard"], in: inputPath).sorted { $0.lastPathComponent < $1.lastPathComponent }.forEach {
		storyboard($0)
	}
	output(to: outputPath)
}

// swiftlint:disable cyclomatic_complexity

func storyboard(_ url: Foundation.URL) {
	do {
		let doc = try XMLDocument(contentsOf: url, options: [])
		var vcs = [XMLElement]()
		if let cs = try doc.nodes(forXPath:"//viewController") as? [XMLElement] {
			vcs.append(contentsOf: cs)
		}
		if let cs = try doc.nodes(forXPath:"//tableViewController") as? [XMLElement] {
			vcs.append(contentsOf: cs)
		}
		if let cs = try doc.nodes(forXPath:"//tabBarController") as? [XMLElement] {
			vcs.append(contentsOf: cs)
		}
		if let cs = try doc.nodes(forXPath:"//navigationController") as? [XMLElement] {
			vcs.append(contentsOf: cs)
		}
		if let cs = try doc.nodes(forXPath:"//splitViewController") as? [XMLElement] {
			vcs.append(contentsOf: cs)
		}
		if let cs = try doc.nodes(forXPath:"//viewControllerPlaceholder") as? [XMLElement] {
			vcs.append(contentsOf: cs)
		}
		if let cs = try doc.nodes(forXPath:"//collectionViewController") as? [XMLElement] {
			vcs.append(contentsOf: cs)
		}
		if let cs = try doc.nodes(forXPath:"//pageViewController") as? [XMLElement] {
			vcs.append(contentsOf: cs)
		}
		if let cs = try doc.nodes(forXPath:"//embed") as? [XMLElement] {
			vcs.append(contentsOf: cs)
		}
		guard vcs.count > 0 else {
			return
		}

		let ids: [(storyboardIdentifier: String, id: String, customClass: String, segues: [String])]! = vcs.compactMap { svc in
			if let storyboardIdentifier = svc.attribute(forName:"storyboardIdentifier")?.stringValue
			, let id = svc.attribute(forName:"id")?.stringValue {
				let customClass = svc.attribute(forName: "customClass")?.stringValue ?? "UIViewController"
				var segues = [String]()
				if let segueNodes = try? svc.nodes(forXPath:"..//segue") {
					segueNodes.forEach {
						if let elem = ($0 as? XMLElement),
							let identifier = elem.attribute(forName:"identifier")?.stringValue,
							!identifier.isEmpty {
							segues.append(identifier)
						}
					}
				}
				return (storyboardIdentifier, id, customClass, segues)
			}
			return nil
		}
		guard ids.isEmpty == false else { return }

		let fileName = url.deletingPathExtension().lastPathComponent
		if fileName.validSwiftString() {
			line("enum Storyboard\(fileName) {")
			line()

			ids.forEach {
				if $0.storyboardIdentifier.validSwiftString() {
					line("struct \($0.storyboardIdentifier): StoryboardScene {")
					line("typealias StoryboardClass = \($0.customClass)")

					if $0.segues.count > 0 {
						line("enum Segue: String, StoryboardSceneSegue {")
						$0.segues.forEach { segue in
							if segue.validSwiftString() {
								line("case \(segue)")
							}
						}
						line("}")
					} else {
						line("struct Segue: StoryboardSceneSegue {")
						line("}")
					}

					line("let identifier = (\"\($0.storyboardIdentifier)\", \"\(fileName)\")")
					line("}")
				}
			}

			line("}")
		}
		line()
	} catch let error {
		print("error: \(error)")
	}
}

main()
